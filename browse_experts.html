<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Expert Consultants - RealEstate Partner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            background-image: 
                linear-gradient(to bottom, rgba(59, 130, 246, 0.05), rgba(59, 130, 246, 0.05)),
                repeating-linear-gradient(0deg, transparent, transparent 79px, #e2e8f0 79px, #e2e8f0 80px),
                repeating-linear-gradient(90deg, transparent, transparent 79px, #e2e8f0 79px, #e2e8f0 80px);
            background-size: 100% 100%, 80px 80px, 80px 80px;
            min-height: 100vh;
        }
        
        /* Profile Dropdown Styles */
        .profile-dropdown {
            position: relative;
            display: inline-block;
        }
        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        .profile-icon img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            background: white;
        }
        .profile-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 50px;
            background: white;
            min-width: 200px;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow: hidden;
        }
        .dropdown-menu.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #374151;
        }
        .dropdown-item:hover {
            background: #f3f4f6;
        }
        .dropdown-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 0.25rem 0;
        }
        
        .consultant-card {
            transition: all 0.3s ease;
        }
        .consultant-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 35px rgba(0, 0, 0, 0.15);
        }
        
        /* Filter Panel Styles */
        .filter-panel {
            display: none;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .filter-panel.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        .filter-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .filter-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .filter-section h4 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        
        .checkbox-label:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .checkbox-label input:checked + span {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .locality-dropdown {
            position: relative;
        }
        
        .locality-search {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .locality-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        
        .locality-item {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background 0.2s;
        }
        
        .locality-item:hover {
            background: #f3f4f6;
        }
        
        .slider-container {
            padding: 0 0.5rem;
        }
        
        .slider-values {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            margin: 0.5rem 0;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }
        
        .filter-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #eff6ff;
            color: #3b82f6;
            padding: 0.375rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .filter-tag button {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
        }
    </style>
</head>
<body>
    <header class="bg-white shadow-lg border-b border-gray-200 p-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-cyan-500 rounded-lg flex items-center justify-center shadow-md">
                <span class="text-white font-bold text-xl">R</span>
            </div>
            <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-cyan-500 bg-clip-text text-transparent">Browse Expert Consultants</h1>
        </div>
        <div class="flex items-center space-x-4">
            <span id="user-display" class="text-gray-600 font-medium">Welcome!</span>
            <div class="profile-dropdown">
                <div class="profile-icon" onclick="toggleProfileMenu()" id="profile-icon">
                    <span id="profile-initials">U</span>
                    <img id="profile-image" style="display: none;" alt="Profile">
                </div>
                <div class="dropdown-menu" id="profile-menu">
                    <div class="dropdown-item" style="pointer-events: none; background: #f9fafb;">
                        <span style="font-weight: 600; color: #1f2937;">üë§ <span id="profile-name">User</span></span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="viewProfile()">
                        <span>‚öôÔ∏è Manage Profile</span>
                    </div>
                    <div class="dropdown-item" onclick="viewSettings()">
                        <span>üîß Settings</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="goBack()" style="color: #dc2626;">
                        <span>üö™ Back to Dashboard</span>
                    </div>
                </div>
            </div>
            <button onclick="goBack()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">
                ‚Üê Back
            </button>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <!-- Search Bar with Filter Button -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex gap-3 items-center">
                <button class="flex items-center justify-center text-gray-500 hover:text-blue-600 transition duration-150" style="min-width: 44px; height: 44px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="search-bar" 
                        placeholder="Search consultants by name, email, or phone..." 
                        onkeyup="searchConsultants()"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-700 placeholder-gray-400"
                    >
                </div>
                <button onclick="toggleFilterPanel()" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition duration-150 flex items-center gap-2">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    <span>Filters</span>
                    <span id="filter-count" class="hidden bg-white text-blue-600 px-2 py-0.5 rounded-full text-xs font-bold"></span>
                </button>
            </div>
        </div>

        <!-- Filter Panel -->
        <div id="filter-panel" class="filter-panel">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Filter Consultants</h3>
                <button onclick="toggleFilterPanel()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>

            <!-- Average Rating Filter -->
            <div class="filter-section">
                <h4>‚≠ê Minimum Rating</h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="rating" value="5" onchange="applyFilters()">
                        <span>5 Stars</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="rating" value="4" onchange="applyFilters()">
                        <span>4+ Stars</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="rating" value="3" onchange="applyFilters()">
                        <span>3+ Stars</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="rating" value="2" onchange="applyFilters()">
                        <span>2+ Stars</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="rating" value="1" onchange="applyFilters()">
                        <span>1+ Star</span>
                    </label>
                </div>
            </div>

            <!-- Expert Localities Filter -->
            <div class="filter-section">
                <h4>üìç Expert Localities</h4>
                <div class="locality-dropdown">
                    <input type="text" id="locality-search" class="locality-search" placeholder="Search localities..." onkeyup="filterLocalities()">
                    <div id="locality-list" class="locality-list">
                        <!-- Localities will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Expert Price Range Filter -->
            <div class="filter-section">
                <h4>üí∞ Expert Price Range</h4>
                <div class="slider-container">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-xs text-gray-600">Min Price (‚Çπ)</label>
                            <input type="range" id="price-min" min="0" max="50000000" step="1000000" value="0" oninput="updatePriceRange(); applyFilters()">
                            <div id="price-min-value" class="text-sm font-semibold text-gray-700">‚Çπ0</div>
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-gray-600">Max Price (‚Çπ)</label>
                            <input type="range" id="price-max" min="0" max="50000000" step="1000000" value="50000000" oninput="updatePriceRange(); applyFilters()">
                            <div id="price-max-value" class="text-sm font-semibold text-gray-700">‚Çπ5 Cr</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expert Square Footage Filter -->
            <div class="filter-section">
                <h4>üìê Expert Square Footage</h4>
                <div class="slider-container">
                    <div class="flex gap-4">
                        <div class="flex-1">
                            <label class="text-xs text-gray-600">Min Sq.Ft</label>
                            <input type="range" id="sqft-min" min="0" max="5000" step="100" value="0" oninput="updateSqftRange(); applyFilters()">
                            <div id="sqft-min-value" class="text-sm font-semibold text-gray-700">0 sq.ft</div>
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-gray-600">Max Sq.Ft</label>
                            <input type="range" id="sqft-max" min="0" max="5000" step="100" value="5000" oninput="updateSqftRange(); applyFilters()">
                            <div id="sqft-max-value" class="text-sm font-semibold text-gray-700">5000 sq.ft</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expert BHK Filter -->
            <div class="filter-section">
                <h4>üè† Expert BHK Types</h4>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="bhk" value="1" onchange="applyFilters()">
                        <span>1 BHK</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="bhk" value="2" onchange="applyFilters()">
                        <span>2 BHK</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="bhk" value="3" onchange="applyFilters()">
                        <span>3 BHK</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="bhk" value="4" onchange="applyFilters()">
                        <span>4 BHK</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="bhk" value="5" onchange="applyFilters()">
                        <span>5 BHK</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" name="bhk" value="5+" onchange="applyFilters()">
                        <span>5+ BHK</span>
                    </label>
                </div>
            </div>

            <!-- Filter Actions -->
            <div class="filter-actions">
                <button onclick="applyFilters()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                    Apply Filters
                </button>
                <button onclick="clearFilters()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-150">
                    Clear All
                </button>
            </div>
        </div>

        <!-- Active Filters -->
        <div id="active-filters" class="active-filters hidden"></div>

        <!-- Results Summary -->
        <div class="mb-6">
            <p id="results-count" class="text-lg font-semibold text-gray-700">Loading consultants...</p>
        </div>

        <!-- Consultants Grid -->
        <div id="consultants-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Consultant cards will be loaded here -->
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center py-12">
            <div class="text-gray-400 text-6xl mb-4">üë®‚Äçüíº</div>
            <h3 class="text-2xl font-bold text-gray-700 mb-2">No Consultants Found</h3>
            <p class="text-gray-500">Try adjusting your search to see more results.</p>
        </div>
    </main>

    <script>
        let allConsultants = [];
        let filteredConsultants = [];
        let consultantExpertise = {}; // Store expertise data for each consultant
        let allLocalities = new Set();
        let activeFilters = {
            rating: [],
            localities: [],
            priceMin: 0,
            priceMax: 50000000,
            sqftMin: 0,
            sqftMax: 5000,
            bhk: []
        };

        document.addEventListener('DOMContentLoaded', async () => {
            displayUserName();
            await loadConsultants();
            await loadConsultantExpertise();
            populateLocalitiesFilter();
        });

        function displayUserName() {
            const firstName = sessionStorage.getItem('loggedInUserFirstName');
            const lastName = sessionStorage.getItem('loggedInUserLastName');
            const username = sessionStorage.getItem('loggedInUserUsername');
            const userDisplayElement = document.getElementById('user-display');

            if (userDisplayElement) {
                if (firstName && lastName) {
                    userDisplayElement.textContent = `Welcome, ${firstName} ${lastName}!`;
                    const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
                    document.getElementById('profile-initials').textContent = initials;
                    document.getElementById('profile-name').textContent = `${firstName} ${lastName}`;
                    if (username) loadProfilePhoto(username);
                } else {
                    userDisplayElement.textContent = `Welcome, Guest!`;
                    document.getElementById('profile-initials').textContent = 'G';
                    document.getElementById('profile-name').textContent = 'Guest';
                }
            }
        }

        function loadProfilePhoto(username) {
            const savedPhoto = localStorage.getItem(`profilePhoto_${username}`);
            if (savedPhoto) {
                const profileIcon = document.getElementById('profile-icon');
                const profileImage = document.getElementById('profile-image');
                const profileInitials = document.getElementById('profile-initials');
                
                if (profileImage && profileInitials && profileIcon) {
                    profileImage.src = savedPhoto;
                    profileImage.style.display = 'block';
                    profileInitials.style.display = 'none';
                    profileIcon.style.background = 'white';
                }
            }
        }

        async function loadConsultants() {
            try {
                // Load user data to get all consultants
                const response = await fetch('user_data.csv');
                const text = await response.text();
                const rows = text.trim().split('\n').slice(1);

                allConsultants = [];
                
                for (const row of rows) {
                    const cols = parseCSVRow(row);
                    // CSV format: role,username,password,email,firstname,lastname,contact,created_date
                    
                    if (cols[0]?.trim() === 'consultant') {
                        const consultant = {
                            role: cols[0].trim(),
                            username: cols[1].trim(),
                            email: cols[3].trim(),
                            firstName: cols[4].trim(),
                            lastName: cols[5].trim(),
                            phone: cols[6].trim()
                        };
                        allConsultants.push(consultant);
                    }
                }

                filteredConsultants = [...allConsultants];
                displayConsultants();

            } catch (error) {
                console.error('Error loading consultants:', error);
                document.getElementById('consultants-container').innerHTML = 
                    '<div class="col-span-full text-center text-red-500 py-8">Error loading consultants. Please try again.</div>';
            }
        }

        async function loadConsultantExpertise() {
            try {
                // Load property details for analyzing consultant expertise
                const buildersResponse = await fetch('builder_listings.csv');
                const buildersText = await buildersResponse.text();
                const builderRows = buildersText.trim().split('\n').slice(1);

                const detailsResponse = await fetch('live_listing_details.csv');
                const detailsText = await detailsResponse.text();
                const detailRows = detailsText.trim().split('\n').slice(1);

                // Analyze each consultant's portfolio
                for (const consultant of allConsultants) {
                    const portfolio = JSON.parse(localStorage.getItem(`consultantPortfolio_${consultant.username}`) || '[]');
                    
                    const localities = new Set();
                    const prices = [];
                    const sqfts = [];
                    const bhks = new Set();

                    for (const item of portfolio) {
                        // Find property in builder listings by timestamp
                        for (const builderRow of builderRows) {
                            const builderCols = parseCSVRow(builderRow);
                            // Match by timestamp (column 6 in builder_listings.csv)
                            if (builderCols[6] === item.timestamp) {
                                const location = builderCols[2]; // Column 2 is location
                                const price = parseFloat(builderCols[4]); // Column 4 is listing_price

                                if (location) {
                                    localities.add(location);
                                    allLocalities.add(location);
                                }
                                if (!isNaN(price)) prices.push(price);

                                // Find matching details by timestamp (column 0 in live_listing_details.csv)
                                const matchingDetail = detailRows.find(detailRow => {
                                    const detailCols = parseCSVRow(detailRow);
                                    return detailCols[0] === item.timestamp;
                                });

                                if (matchingDetail) {
                                    const detailCols = parseCSVRow(matchingDetail);
                                    const sqft = parseFloat(detailCols[1]); // Column 1 is sq_ft
                                    const bhk = detailCols[2]; // Column 2 is num_bedrooms

                                    if (!isNaN(sqft)) sqfts.push(sqft);
                                    if (bhk) bhks.add(bhk);
                                }

                                break; // Found the property, move to next portfolio item
                            }
                        }
                    }

                    consultantExpertise[consultant.username] = {
                        localities: Array.from(localities),
                        priceMin: prices.length > 0 ? Math.min(...prices) : 0,
                        priceMax: prices.length > 0 ? Math.max(...prices) : 0,
                        sqftMin: sqfts.length > 0 ? Math.min(...sqfts) : 0,
                        sqftMax: sqfts.length > 0 ? Math.max(...sqfts) : 0,
                        bhks: Array.from(bhks),
                        rating: 5.0 // Default rating, can be updated from reviews
                    };
                }

            } catch (error) {
                console.error('Error loading consultant expertise:', error);
            }
        }

        function populateLocalitiesFilter() {
            const localityList = document.getElementById('locality-list');
            const localities = Array.from(allLocalities).sort();
            
            if (localities.length === 0) {
                localityList.innerHTML = '<div class="text-gray-500 text-sm p-2">No localities available</div>';
                return;
            }

            localityList.innerHTML = localities.map(locality => `
                <label class="locality-item flex items-center gap-2">
                    <input type="checkbox" value="${locality}" onchange="applyFilters()">
                    <span>${locality}</span>
                </label>
            `).join('');
        }

        function filterLocalities() {
            const searchTerm = document.getElementById('locality-search').value.toLowerCase();
            const localities = document.querySelectorAll('.locality-item');
            
            localities.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function toggleFilterPanel() {
            const panel = document.getElementById('filter-panel');
            panel.classList.toggle('show');
        }

        function updatePriceRange() {
            const minInput = document.getElementById('price-min');
            const maxInput = document.getElementById('price-max');
            const minValue = parseInt(minInput.value);
            const maxValue = parseInt(maxInput.value);
            
            // Ensure min doesn't exceed max
            if (minValue > maxValue) {
                minInput.value = maxValue;
            }
            
            document.getElementById('price-min-value').textContent = formatPrice(minInput.value);
            document.getElementById('price-max-value').textContent = formatPrice(maxInput.value);
            
            activeFilters.priceMin = parseInt(minInput.value);
            activeFilters.priceMax = parseInt(maxInput.value);
        }

        function updateSqftRange() {
            const minInput = document.getElementById('sqft-min');
            const maxInput = document.getElementById('sqft-max');
            const minValue = parseInt(minInput.value);
            const maxValue = parseInt(maxInput.value);
            
            // Ensure min doesn't exceed max
            if (minValue > maxValue) {
                minInput.value = maxValue;
            }
            
            document.getElementById('sqft-min-value').textContent = minInput.value + ' sq.ft';
            document.getElementById('sqft-max-value').textContent = maxInput.value + ' sq.ft';
            
            activeFilters.sqftMin = parseInt(minInput.value);
            activeFilters.sqftMax = parseInt(maxInput.value);
        }

        function applyFilters() {
            // Collect rating filters
            const ratingCheckboxes = document.querySelectorAll('input[name="rating"]:checked');
            activeFilters.rating = Array.from(ratingCheckboxes).map(cb => parseFloat(cb.value));
            
            // Collect locality filters
            const localityCheckboxes = document.querySelectorAll('#locality-list input[type="checkbox"]:checked');
            activeFilters.localities = Array.from(localityCheckboxes).map(cb => cb.value);
            
            // Collect BHK filters
            const bhkCheckboxes = document.querySelectorAll('input[name="bhk"]:checked');
            activeFilters.bhk = Array.from(bhkCheckboxes).map(cb => cb.value);
            
            // Update price and sqft from sliders
            updatePriceRange();
            updateSqftRange();
            
            // Apply filters to consultants
            const searchTerm = document.getElementById('search-bar').value.toLowerCase();
            
            filteredConsultants = allConsultants.filter(consultant => {
                const expertise = consultantExpertise[consultant.username];
                
                // If no expertise data, exclude from filtered results
                if (!expertise) return false;
                
                // Apply text search
                const fullName = `${consultant.firstName} ${consultant.lastName}`.toLowerCase();
                const matchesSearch = !searchTerm || 
                    fullName.includes(searchTerm) ||
                    consultant.email.toLowerCase().includes(searchTerm) ||
                    consultant.phone.includes(searchTerm) ||
                    consultant.username.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return false;
                
                // Apply rating filter (if any selected, consultant must meet minimum rating)
                if (activeFilters.rating.length > 0) {
                    const minRating = Math.min(...activeFilters.rating);
                    if (expertise.rating < minRating) return false;
                }
                
                // Apply locality filter (consultant must have expertise in at least one selected locality)
                if (activeFilters.localities.length > 0) {
                    const hasLocality = activeFilters.localities.some(loc => expertise.localities.includes(loc));
                    if (!hasLocality) return false;
                }
                
                // Apply price range filter (consultant's expertise must overlap with selected range)
                if (expertise.priceMax < activeFilters.priceMin || expertise.priceMin > activeFilters.priceMax) {
                    return false;
                }
                
                // Apply sqft range filter (consultant's expertise must overlap with selected range)
                if (expertise.sqftMax < activeFilters.sqftMin || expertise.sqftMin > activeFilters.sqftMax) {
                    return false;
                }
                
                // Apply BHK filter (consultant must have expertise in at least one selected BHK)
                if (activeFilters.bhk.length > 0) {
                    const hasBHK = activeFilters.bhk.some(bhk => {
                        if (bhk === '5+') {
                            return expertise.bhks.some(b => parseInt(b) >= 5);
                        }
                        return expertise.bhks.includes(bhk);
                    });
                    if (!hasBHK) return false;
                }
                
                return true;
            });
            
            displayConsultants();
            updateActiveFiltersDisplay();
            updateFilterCount();
        }

        function clearFilters() {
            // Reset all filter inputs
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('price-min').value = 0;
            document.getElementById('price-max').value = 50000000;
            document.getElementById('sqft-min').value = 0;
            document.getElementById('sqft-max').value = 5000;
            document.getElementById('locality-search').value = '';
            
            // Reset active filters
            activeFilters = {
                rating: [],
                localities: [],
                priceMin: 0,
                priceMax: 50000000,
                sqftMin: 0,
                sqftMax: 5000,
                bhk: []
            };
            
            updatePriceRange();
            updateSqftRange();
            filterLocalities();
            applyFilters();
        }

        function updateActiveFiltersDisplay() {
            const container = document.getElementById('active-filters');
            const tags = [];
            
            // Rating tags
            if (activeFilters.rating.length > 0) {
                const minRating = Math.min(...activeFilters.rating);
                tags.push(`‚≠ê ${minRating}+ Stars`);
            }
            
            // Locality tags
            activeFilters.localities.forEach(locality => {
                tags.push(`üìç ${locality}`);
            });
            
            // Price range tag
            if (activeFilters.priceMin > 0 || activeFilters.priceMax < 50000000) {
                tags.push(`üí∞ ${formatPrice(activeFilters.priceMin)} - ${formatPrice(activeFilters.priceMax)}`);
            }
            
            // Sqft range tag
            if (activeFilters.sqftMin > 0 || activeFilters.sqftMax < 5000) {
                tags.push(`üìê ${activeFilters.sqftMin} - ${activeFilters.sqftMax} sq.ft`);
            }
            
            // BHK tags
            activeFilters.bhk.forEach(bhk => {
                tags.push(`üè† ${bhk} BHK`);
            });
            
            if (tags.length === 0) {
                container.classList.add('hidden');
                container.innerHTML = '';
            } else {
                container.classList.remove('hidden');
                container.innerHTML = tags.map((tag, index) => `
                    <div class="filter-tag">
                        <span>${tag}</span>
                        <button onclick="removeFilterTag(${index})">&times;</button>
                    </div>
                `).join('');
            }
        }

        function updateFilterCount() {
            const count = activeFilters.rating.length + activeFilters.localities.length + activeFilters.bhk.length +
                         (activeFilters.priceMin > 0 || activeFilters.priceMax < 50000000 ? 1 : 0) +
                         (activeFilters.sqftMin > 0 || activeFilters.sqftMax < 5000 ? 1 : 0);
            
            const countEl = document.getElementById('filter-count');
            if (count > 0) {
                countEl.textContent = count;
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }
        }

        function removeFilterTag(tagIndex) {
            let currentIndex = 0;
            
            // Check if it's the rating tag
            if (activeFilters.rating.length > 0) {
                if (tagIndex === currentIndex) {
                    // Uncheck all rating checkboxes
                    document.querySelectorAll('input[name="rating"]').forEach(cb => cb.checked = false);
                    activeFilters.rating = [];
                    applyFilters();
                    return;
                }
                currentIndex++;
            }
            
            // Check if it's a locality tag
            for (let i = 0; i < activeFilters.localities.length; i++) {
                if (tagIndex === currentIndex) {
                    const localityToRemove = activeFilters.localities[i];
                    // Uncheck the locality checkbox
                    const localityCheckboxes = document.querySelectorAll('#locality-list input[type="checkbox"]');
                    localityCheckboxes.forEach(cb => {
                        if (cb.value === localityToRemove) {
                            cb.checked = false;
                        }
                    });
                    activeFilters.localities.splice(i, 1);
                    applyFilters();
                    return;
                }
                currentIndex++;
            }
            
            // Check if it's the price range tag
            if (activeFilters.priceMin > 0 || activeFilters.priceMax < 50000000) {
                if (tagIndex === currentIndex) {
                    // Reset price range
                    document.getElementById('price-min').value = 0;
                    document.getElementById('price-max').value = 50000000;
                    activeFilters.priceMin = 0;
                    activeFilters.priceMax = 50000000;
                    updatePriceRange();
                    applyFilters();
                    return;
                }
                currentIndex++;
            }
            
            // Check if it's the sqft range tag
            if (activeFilters.sqftMin > 0 || activeFilters.sqftMax < 5000) {
                if (tagIndex === currentIndex) {
                    // Reset sqft range
                    document.getElementById('sqft-min').value = 0;
                    document.getElementById('sqft-max').value = 5000;
                    activeFilters.sqftMin = 0;
                    activeFilters.sqftMax = 5000;
                    updateSqftRange();
                    applyFilters();
                    return;
                }
                currentIndex++;
            }
            
            // Check if it's a BHK tag
            for (let i = 0; i < activeFilters.bhk.length; i++) {
                if (tagIndex === currentIndex) {
                    const bhkToRemove = activeFilters.bhk[i];
                    // Uncheck the BHK checkbox
                    const bhkCheckboxes = document.querySelectorAll('input[name="bhk"]');
                    bhkCheckboxes.forEach(cb => {
                        if (cb.value === bhkToRemove) {
                            cb.checked = false;
                        }
                    });
                    activeFilters.bhk.splice(i, 1);
                    applyFilters();
                    return;
                }
                currentIndex++;
            }
        }

        function formatPrice(price) {
            const numPrice = parseFloat(price);
            if (numPrice >= 10000000) {
                return `‚Çπ${(numPrice / 10000000).toFixed(1)} Cr`;
            } else if (numPrice >= 100000) {
                return `‚Çπ${(numPrice / 100000).toFixed(1)} L`;
            }
            return `‚Çπ${numPrice.toLocaleString('en-IN')}`;
        }

        function searchConsultants() {
            applyFilters();
        }

        function displayConsultants() {
            const container = document.getElementById('consultants-container');
            const noResults = document.getElementById('no-results');
            const resultsCount = document.getElementById('results-count');

            resultsCount.textContent = `Found ${filteredConsultants.length} ${filteredConsultants.length === 1 ? 'consultant' : 'consultants'}`;

            if (filteredConsultants.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                return;
            }

            noResults.classList.add('hidden');
            container.innerHTML = filteredConsultants.map(consultant => createConsultantCard(consultant)).join('');
        }

        function createConsultantCard(consultant) {
            const fullName = `${consultant.firstName} ${consultant.lastName}`;
            const initials = (consultant.firstName.charAt(0) + consultant.lastName.charAt(0)).toUpperCase();
            
            // Check if consultant has a profile photo
            const savedPhoto = localStorage.getItem(`profilePhoto_${consultant.username}`);
            const photoHtml = savedPhoto 
                ? `<img src="${savedPhoto}" class="w-full h-full object-cover" alt="${fullName}">`
                : `<span class="text-3xl font-bold text-white">${initials}</span>`;

            return `
                <div class="consultant-card bg-white rounded-2xl shadow-xl border-2 border-gray-200 overflow-hidden hover:border-teal-300 transition-all duration-300">
                    <div class="bg-gradient-to-br from-teal-500 via-teal-600 to-cyan-600 p-8 text-center relative overflow-hidden">
                        <div class="absolute inset-0 bg-black opacity-0 hover:opacity-10 transition-opacity duration-300"></div>
                        <div class="w-28 h-28 mx-auto rounded-full bg-white flex items-center justify-center overflow-hidden mb-4 border-4 border-white shadow-2xl relative z-10">
                            ${photoHtml}
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-1 relative z-10">${fullName}</h3>
                        <div class="inline-flex items-center bg-white/20 backdrop-blur-sm px-4 py-1.5 rounded-full mt-2 relative z-10">
                            <svg class="w-4 h-4 text-white mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-sm font-semibold text-white">Real Estate Consultant</p>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="space-y-3 mb-6">
                            <div class="flex items-center bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-xl border border-blue-200">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                                <span class="text-sm text-gray-700 font-medium truncate">${consultant.email}</span>
                            </div>
                            <div class="flex items-center bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-xl border border-green-200">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                    </svg>
                                </div>
                                <span class="text-sm text-gray-700 font-medium">${consultant.phone}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="viewConsultantProfile('${consultant.username}')" 
                                class="flex-1 inline-flex items-center justify-center bg-white hover:bg-gray-50 text-gray-700 font-semibold py-3 px-4 rounded-xl border-2 border-gray-300 hover:border-teal-500 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md text-sm">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Portfolio
                            </button>
                            <button onclick="selectConsultant('${consultant.username}', '${fullName}', '${consultant.phone}', '${consultant.email}')" 
                                class="flex-1 inline-flex items-center justify-center bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white font-semibold py-3 px-4 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-md hover:shadow-lg text-sm">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                Connect
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function viewProfile(username) {
            window.open(`consultant_public_profile.html?username=${username}`, '_blank');
        }

        function selectConsultant(username, name, phone, email) {
            const customerEmail = sessionStorage.getItem('loggedInUserEmail');
            if (!customerEmail) {
                alert('Please login to contact consultant');
                window.location.href = 'customer/login.html';
                return;
            }

            const customerFirstName = sessionStorage.getItem('loggedInUserFirstName') || 'Customer';
            const customerLastName = sessionStorage.getItem('loggedInUserLastName') || '';
            const customerName = `${customerFirstName} ${customerLastName}`.trim();
            const customerPhone = sessionStorage.getItem('loggedInUserPhone') || '';

            // Create consultant connect request
            const request = {
                id: Date.now(),
                consultantName: name,
                consultantPhone: phone,
                consultantEmail: email,
                customerName: customerName,
                customerPhone: customerPhone,
                customerEmail: customerEmail,
                requestType: 'Browse Experts Contact',
                status: 'Pending',
                timestamp: new Date().toISOString()
            };

            // Save to localStorage
            const consultantRequests = JSON.parse(localStorage.getItem('consultantConnectRequests') || '[]');
            consultantRequests.push(request);
            localStorage.setItem('consultantConnectRequests', JSON.stringify(consultantRequests));

            alert(`Contact request sent!\n\n${name} will reach out to you shortly.`);
        }

        function parseCSVRow(row) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('show');
        }

        function viewProfile() {
            window.location.href = 'manage_profile.html';
        }

        function viewConsultantProfile(username) {
            window.location.href = `consultant_public_profile.html?username=${username}`;
        }

        function viewSettings() {
            alert('Settings page coming soon!');
        }

        function goBack() {
            window.location.href = 'customer_dashboard.html';
        }

        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.profile-dropdown');
            const menu = document.getElementById('profile-menu');
            if (dropdown && !dropdown.contains(event.target)) {
                menu.classList.remove('show');
            }
        });
    </script>
</body>
</html>
